<!DOCTYPE html>
<html>
<head>
    <title>Admin - Resultados do Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Painel Administrativo</h1>
            <div>
                <a href="/" class="btn btn-secondary">Página Inicial</a>
                <form action="/limpar_dados" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja limpar todos os dados?')">
                        Limpar Todos os Dados
                    </button>
                </form>
            </div>
        </div>

        <!-- Estatísticas Gerais -->
        {% if resultados %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h4>{{ resultados|length }}</h4>
                        <p>Total de Tentativas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h4>{{ "%.1f"|format((resultados|map(attribute='percentual')|sum / resultados|length)) }}%</h4>
                        <p>Média de Acertos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h4>{{ (resultados|map(attribute='pontuacao')|max) }}</h4>
                        <p>Maior Pontuação</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h4>{{ (resultados|map(attribute='pontuacao')|min) }}</h4>
                        <p>Menor Pontuação</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Desempenho -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Desempenho Geral dos Participantes</h3>
            </div>
            <div class="card-body">
                <canvas id="graficoAdmin" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Tabela de Resultados -->
        <div class="card">
            <div class="card-header">
                <h3>Detalhes de Todas as Tentativas</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data/Hora</th>
                                <th>Pontuação</th>
                                <th>Acertos</th>
                                <th>Percentual</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for resultado in resultados|reverse %}
                            <tr>
                                <td>{{ resultado.id }}</td>
                                <td>{{ resultado.timestamp[:16]|replace('T', ' ') }}</td>
                                <td>{{ resultado.pontuacao }}/{{ resultado.total_perguntas * 10 }}</td>
                                <td>{{ resultado.acertos }}/{{ resultado.total_perguntas }}</td>
                                <td>
                                    <span class="badge
                                        {% if resultado.percentual >= 80 %}bg-success
                                        {% elif resultado.percentual >= 60 %}bg-info
                                        {% elif resultado.percentual >= 40 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ "%.1f"|format(resultado.percentual) }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#detalhes{{ resultado.id }}">
                                        Ver Respostas
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse" id="detalhes{{ resultado.id }}">
                                <td colspan="6">
                                    <div class="p-3 bg-light">
                                        <h6>Detalhes das Respostas:</h6>
                                        {% for detalhe in resultado.detalhes_respostas %}
                                        <div class="mb-2 p-2 border rounded {% if detalhe.acertou %}border-success{% else %}border-danger{% endif %}">
                                            <strong>P{{ detalhe.pergunta_id }}:</strong> {{ detalhe.pergunta_texto }}<br>
                                            <small>
                                                Resposta: {{ detalhe.resposta_usuario + 1 if detalhe.resposta_usuario is not none else 'N/A' }} |
                                                Correta: {{ detalhe.resposta_correta + 1 }} |
                                                <span class="{% if detalhe.acertou %}text-success{% else %}text-danger{% endif %}">
                                                    {{ '✓ Acertou' if detalhe.acertou else '✗ Errou' }}
                                                </span>
                                            </small>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h4>Nenhum dado disponível</h4>
            <p>Ainda não há resultados armazenados.</p>
            <a href="/quiz" class="btn btn-primary">Fazer Primeiro Quiz</a>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Gráfico para admin
        fetch('/dados')
            .then(response => response.json())
            .then(data => {
                if (data.labels.length > 0) {
                    const ctx = document.getElementById('graficoAdmin').getContext('2d');

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Pontuação',
                                data: data.pontuacoes,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }, {
                                label: 'Percentual (%)',
                                data: data.percentuais,
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 50 // total de pontos possíveis
                                },
                                y1: {
                                    beginAtZero: true,
                                    max: 100,
                                    position: 'right'
                                }
                            }
                        }
                    });
                }
            });
    </script>
</body>
</html>